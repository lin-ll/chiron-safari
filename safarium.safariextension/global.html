<!DOCTYPE html>
<head>
</head>
<body>
<script type="text/javascript" charset="utf-8">
    // Set up the Listener
    safari.application.addEventListener("command", performCommand, false);
    safari.application.addEventListener("message", handleMessage, false);

    function performCommand(event) {
    	if (event.command == "safarium") {
    		alert("Long click on the extension to show the options. Select an option to turn on Latin or Greek translations. Then, just double-click any word on your page, and you'll see the translation in a blue panel top right.");
    	}
        else if (event.command == "latin") {
            safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("language", "latin");
        }
        else if (event.command == "greek") {
        	safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("language", "greek");
        }
        else return;
    }

    function handleMessage(msgEvent) {
    	var word = msgEvent.message[0];
    	var langCode = msgEvent.message[1];

		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (xhttp.readyState == 4 && xhttp.status == 200) {
				var response = [word, xhttp.responseText];
				// alert(response);
				safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("ajax", response);
			}
		};
		xhttp.open("GET", 'http://www.perseus.tufts.edu/hopper/morph?l='+ word + '&la='+langCode, true);
		xhttp.setRequestHeader("cache-control", "no-cache");
		xhttp.send();
    }
</script>
</body>
</html>